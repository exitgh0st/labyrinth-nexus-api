generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                   String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                                String      @unique @db.VarChar(255)
  email_verified                       Boolean     @unique @default(false)
  email_verified_at                    DateTime?   @db.Timestamp(6)
  password_hash                        String      @db.VarChar(255)
  first_name                           String?     @db.VarChar(100)
  last_name                            String?     @db.VarChar(100)
  display_name                         String?     @db.VarChar(100)
  avatar_url                           String?     @db.VarChar(500)
  is_active                            Boolean?    @default(true)
  is_deleted                           Boolean?    @default(false)
  deleted_at                           DateTime?   @db.Timestamp(6)
  last_login_at                        DateTime?   @db.Timestamp(6)
  failed_login_attempts                Int?        @default(0)
  locked_until                         DateTime?   @db.Timestamp(6)
  password_changed_at                  DateTime?   @db.Timestamp(6)
  created_at                           DateTime    @default(now()) @db.Timestamp(6)
  updated_at                           DateTime    @default(now()) @db.Timestamp(6)
  session                              Session[]
  user_role_user_role_granted_byTouser UserRole[] @relation("user_role_granted_byTouser")
  user_role_user_role_user_idTouser    UserRole[] @relation("user_role_user_idTouser")

  @@map("user")
}

model Session {
  id                  Int       @id @default(autoincrement())
  user_id             String    @db.Uuid
  session_id          String    @unique @db.VarChar(255)
  refresh_token_hash  String    @unique @db.VarChar(255)
  ip_address          String?   @db.VarChar(45)
  user_agent          String?
  is_revoked          Boolean   @default(false)
  expires_at          DateTime  @db.Timestamp(6)
  previous_session_id Int?
  created_at          DateTime  @default(now()) @db.Timestamp(6)
  updated_at          DateTime  @default(now()) @db.Timestamp(6)
  last_used_at        DateTime? @db.Timestamp(6)
  user                User      @relation(fields: [user_id], references: [id], onDelete: Cascade, map: "fk_session_user_id")

  @@index([refresh_token_hash], map: "idx_session_refresh_token_hash")
  @@index([session_id], map: "idx_session_session_id")
  @@index([user_id, is_revoked, expires_at], map: "idx_session_user_revoked_expires")
  @@map("session")
}

model Role {
  id          Int         @id @default(autoincrement())
  name        String      @unique @db.VarChar(50)
  description String?
  is_active   Boolean?    @default(true)
  created_at  DateTime    @default(now()) @db.Timestamp(6)
  updated_at  DateTime    @default(now()) @db.Timestamp(6)
  user_role   UserRole[]

  @@map("role")
}

model UserRole {
  id                              Int       @id @default(autoincrement())
  user_id                         String    @db.Uuid
  role_id                         Int
  granted_at                      DateTime? @default(now()) @db.Timestamp(6)
  granted_by                      String?   @db.Uuid
  user_user_role_granted_byTouser User?     @relation("user_role_granted_byTouser", fields: [granted_by], references: [id], map: "fk_user_role_granted_by")
  role                            Role      @relation(fields: [role_id], references: [id], onDelete: Cascade, map: "fk_user_role_role_id")
  user_user_role_user_idTouser    User      @relation("user_role_user_idTouser", fields: [user_id], references: [id], onDelete: Cascade, map: "fk_user_role_user_id")

  @@unique([user_id, role_id], map: "uq_user_role_userid_roleid")
  @@index([role_id], map: "idx_user_role_role_id")
  @@index([user_id], map: "idx_user_role_user_id")

  @@map("user_role")
}
